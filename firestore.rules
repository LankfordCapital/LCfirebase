
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Allow connection test documents
    match /_test/{document} {
      allow read, write: if request.auth != null;
    }
    
    // Allow Firebase test collection for debugging
    match /firebase-test/{document} {
      allow read, write: if request.auth != null;
    }
    
    // Allow users to read and write their own residential NOO ground up construction applications
    match /residential-noo-ground-up-construction-applications/{applicationId} {
      allow read, write, create, update, delete: if request.auth != null && (
        // Users can access their own applications
        resource.data.userId == request.auth.uid ||
        // Brokers can access applications they created
        resource.data.brokerId == request.auth.uid ||
        // Allow creation of new applications (no resource.data yet)
        request.method == 'create'
      );
    }
    
    // Allow users to read and write their own documents
    // Allow admin users to read and update all user documents
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        // Admin users have full access to all user documents
        request.auth.uid in ['UCqwzQPlG4Xcb3BzcxGQ8JvjDba2', 'LQYGVdjvcAOB58nnK4lzP3sgW6B2', 'Wvzsq4sWJWf3NOjwMgMhqpw4O9b2'] ||
        // Allow workforce users to read all user documents for management purposes
        request.auth.uid != null
      );
      allow update, delete: if request.auth != null && (
        request.auth.uid == userId || 
        // Allow admin users to update all user documents
        request.auth.uid in ['UCqwzQPlG4Xcb3BzcxGQ8JvjDba2', 'LQYGVdjvcAOB58nnK4lzP3sgW6B2', 'Wvzsq4sWJWf3NOjwMgMhqpw4O9b2']
      );
      allow create: if request.auth != null;
    }

    // Allow workforce members and admins to manage appointments
    match /appointments/{appointmentId} {
      allow read, write: if request.auth != null;
    }

    // Allow users to manage their own loan applications
    match /loanApplications/{applicationId} {
      allow read, write, create: if request.auth != null;
    }

    // Allow workforce members and admins to read all loan applications
    match /loanApplications/{applicationId} {
      allow read: if request.auth != null;
    }

    // Allow users to manage their own documents
    match /documents/{documentId} {
      allow read, write, create: if request.auth != null;
    }

    // Allow workforce members and admins to read all documents
    match /documents/{documentId} {
      allow read: if request.auth != null;
    }

    // Allow workforce members and admins to manage workforce documents
    match /workforce-docs/{documentId} {
      allow read, write, create, delete: if request.auth != null;
    }

    // Allow users to manage their own borrower profiles
    match /borrower-profiles/{profileId} {
      allow read, write, create: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        // Brokers can access borrower profiles they created
        resource.data.createdBy == request.auth.uid ||
        // Workforce members can read all borrower profiles
        request.auth.uid != null
      );
    }

    // Allow users to manage their own borrowers
    match /borrowers/{borrowerId} {
      allow read, write, create: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        // Brokers can access borrowers they created
        resource.data.createdBy == request.auth.uid ||
        // Workforce members can read all borrowers
        request.auth.uid != null
      );
    }

    // Allow workforce members and admins to manage workforce members
    match /workforce-members/{memberId} {
      allow read, write, create, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage comparable properties
    match /comparable-properties/{propertyId} {
      allow read, write, create, delete: if request.auth != null;
    }

    // Allow authenticated users to manage invitations
    match /invitations/{invitationId} {
      allow read, write, create, update: if request.auth != null;
    }

    // Allow authenticated users to manage chat rooms
    match /chatRooms/{roomId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow the email service to create mail documents (for sending emails)
    match /mail/{mailId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false; // Only allow creation, not reading/modifying
    }

    // Allow users to manage chat messages
    match /chatMessages/{messageId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow users to manage chat rooms and messages in subcollections
    match /chats/{roomId} {
      allow read, write, create, update, delete: if request.auth != null;
      
      // Allow access to messages subcollection
      match /messages/{messageId} {
        allow read, write, create, update, delete: if request.auth != null;
      }
    }

    // Allow users to manage chat messages (alternative collection structure)
    match /chatMessages/{messageId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage market analyses
    match /market-analyses/{analysisId} {
      allow read, write, create, delete: if request.auth != null;
    }

    // Allow users to manage their own enhanced loan applications
    match /enhancedLoanApplications/{applicationId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow users to manage their own borrower documents
    match /borrower-documents/{documentId} {
      allow read, write, create, update, delete: if request.auth != null && (
        resource.data.borrowerId == request.auth.uid ||
        // Allow creation of new documents (no resource.data yet)
        request.method == 'create'
      );
    }

    // Allow users to manage their own personal financial statements
    match /personalFinancialStatements/{statementId} {
      allow read, write, create, update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        // Allow creation of new statements (no resource.data yet)
        request.method == 'create'
      );
    }

    // Allow users to manage their own business debt schedules
    match /businessDebtSchedules/{scheduleId} {
      allow read, write, create, update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        // Allow creation of new schedules (no resource.data yet)
        request.method == 'create'
      );
    }

    // Allow users to manage their own broker documents
    match /broker-documents/{documentId} {
      allow read, write, create, update, delete: if request.auth != null && (
        resource.data.brokerId == request.auth.uid ||
        // Allow creation of new documents (no resource.data yet)
        request.method == 'create'
      );
    }

    // Allow workforce members and admins to manage lenders database
    match /lenders/{lenderId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage lender profiles
    match /lender-profiles/{profileId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage lender matches
    match /lender-matches/{matchId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage market data
    match /market-data/{dataId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage deal analysis
    match /deal-analysis/{analysisId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage AMC database
    match /amcs/{amcId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members and admins to manage AMC profiles
    match /amc-profiles/{profileId} {
      allow read, write, create, update, delete: if request.auth != null;
    }

    // Allow workforce members to manage their own appointments
    match /appointments/{appointmentId} {
      allow read, write, create, update, delete: if request.auth != null && (
        resource.data.workforceMemberId == request.auth.uid ||
        // Allow creation of new appointments (no resource.data yet)
        request.method == 'create'
      );
    }
    
    // Allow collection initialization documents
    match /{collection}/{document} {
      allow read, write: if request.auth != null && 
        document == '_init' && 
        (collection == 'enhancedLoanApplications' || 
         collection == 'users' || 
         collection == 'borrower-profiles' ||
         collection == 'borrower-documents' ||
         collection == 'personalFinancialStatements' ||
         collection == 'businessDebtSchedules' ||
         collection == 'broker-documents' ||
         collection == 'lenders' ||
         collection == 'lender-profiles' ||
         collection == 'lender-matches' ||
         collection == 'market-data' ||
         collection == 'deal-analysis' ||
         collection == 'amcs' ||
         collection == 'amc-profiles');
    }
  }
}
